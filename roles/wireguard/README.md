# xsrv.wireguard

This role will install [Wireguard](https://en.wikipedia.org/wiki/WireGuard), a [virtual private network (VPN)](https://en.wikipedia.org/wiki/Virtual_private_network) server designed with the goals of ease of use, high speed performance, and low attack surface.

Clients of the wireguard server will be able to route part or whole of their network traffic through it.

## Requirements/dependencies/example playbook

- See [meta/main.yml](meta/main.yml)
- The server's UDP port `51820` must be reachable by clients. Configure NAT/port forwarding on your router if necessary, and allow port `51820/udp` in the host's firewall (if the [`ansible.xsrv.common`](../common) role is deployed, a `firewalld` rule is automatically added).
- IP forwarding must be enabled on the host, for example using the [common](../common) role: `sysctl_allow_forwarding: yes`

```yaml
# playbook.yml
- hosts: my.CHANGEME.org
  roles:
    - nodiscc.xsrv.common # (optional) base server setup, hardening, firewall
    - nodiscc.xsrv.monitoring # (optional) system/server monitoring and health checks
    - nodiscc.xsrv.backup # (optional) automatic local backup of private keys
    - nodiscc.xsrv.dnsmasq # DNS resolution for VPN clients
    - nodiscc.xsrv.wireguard

# required variables
# host_vars/my.CHANGEME.org/my.CHANGEME.org.yml
wireguard_server_public_ip: "CHANGEME"
wireguard_peers:
  - name: client1
    public_key: Faz...4vEQ=
    ip_address: "10.200.200.10/24"
```

See [defaults/main.yml](defaults/main.yml) for all configuration variables.


## Usage

### Connecting VPN clients

Two methods are available to configure VPN clients (peers).


#### Key generation on the client

This method is preferred, since the private key never leaves the client (only the public key is transmitted to the server administrator). However it requires an additional back-and-forth between the client/server:
- generate the private/public key pair on the client. For example the server admin could send the following text to the user of the client machine:

> Please generate a public/private key:
> ```bash
> sudo apt install wireguard-tools
> wg genkey | (umask 0077 && tee wireguard.key) | wg pubkey > wireguard.pub
> # display the public key
> cat wireguard.pub
> ```
> Then send the public key file to the VPN server administrator, and keep `wireguard.key` somewhere safe on your machine.

- add the client to `wireguard_peers:` using the `public_key` value received from the client (see example above)
- deploy the wireguard role (`xsrv deploy`)
- SSH to the wireguard server (`xsrv ssh`), run `sudo cat /etc/wireguard/peers/client-config/$CLIENT_NAME.conf` and send the contents of this file to the client. It contains furter instructions to setup the VPN connection.


#### Automatic key generation on the server

This method is quicker since it only requires configuring a client in `wireguard_peers` and deploying the role, without having the client generate a `public_key` beforehand:

- SSH to the wireguard server (`xsrv ssh`)
- display the configuration: `sudo cat /etc/wireguard/peers/client-config/$CLIENT_NAME.conf` OR display the configuration as a QR code `sudo cat /etc/wireguard/peers/client-config/$CLIENT_NAME.qrcode`
- send the contents of the configuration file to the client (over a secure channel since it contains the private key) or have the client scan the QR code directly.

Mobile wireguard clients:
* [WG Tunnel](https://f-droid.org/en/packages/com.zaneschepke.wireguardautotunnel/)

### Other

#### List connected clients

Access the server over SSH (`xsrv ssh`) and run `sudo wg`.


#### Only allow VPN clients to connect to a service on the host

When firewalld is managed by the [common](../common/) role, by default VPN clients are part of the `internal` zone. To make VPN clients part of the `wireguard` zone instead:

```yaml
firewalld_zone_sources:
  - zone: internal
    sources:
      - 192.168.0.0/24
      - 10.0.1.0/24
      - 10.0.2.0/24
      - ...
  - zone: internal
    sources:
      - 10.0.0.0/8 # remove 10.0.0.0/8 from the internal zone
    state: absent

apache_firewalld_zones:
  - zone: public
    state: disabled
  - zone: internal
    state: disabled # disallow connections from LAN to the service
  - zone: wireguard
    state: enabled # explicitely allow connections from wireguard sources
```


### Debugging

You can turn on debug logging at any time by running `echo module wireguard +p | sudo tee /sys/kernel/debug/dynamic_debug/control`. To disable debug logging: `echo module wireguard -p | sudo tee /sys/kernel/debug/dynamic_debug/control`. Debug logging will log events such as peers connecting/disconnecting and rejected connection attempts.


### Troubleshooting

**Unexpected failure during module execution: Incorrect padding:** make sure `public_key`s for `wireguard_peers` are valid 44 character long base64 keys generated by `wg genkey` or similar.


### Backups

The server's private/public keys should be backed up. See the included [rsnapshot configuration](templates/etc/rsnapshot.d_wireguard.conf.j2) for information about directories to backup/restore.


## Tags

<!--BEGIN TAGS LIST-->
```
wireguard - setup wireguard
```
<!--END TAGS LIST-->


## License

[GNU GPLv3](../../LICENSE)


## References

- https://stdout.root.sx/links/?searchterm=wireguard
- https://stdout.root.sx/links/?searchtags=vpn
