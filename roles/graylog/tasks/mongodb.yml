### MONGODB ###

- name: add mongodb APT signing keys
  copy:
    src: usr_share_keyrings_mongodb.gpg
    dest: /usr/share/keyrings/mongodb.gpg
    owner: root
    group: root
    mode: "0644"
  notify: update apt cache

- name: add mongodb APT repository
  template:
    src: etc_apt_sources.list.d_mongodb.list.j2
    dest: /etc/apt/sources.list.d/mongodb.list
    owner: root
    group: root
    mode: "0644"
  notify: update apt cache

# update APT cache for mongodb packages to become available
- name: apply configuration (flush handlers)
  meta: flush_handlers

- name: install mongodb packages
  apt:
    package:
      - mongodb-org
      - mongodb-org-database
      - mongodb-org-database-tools-extra
      - mongodb-org-mongos
      - mongodb-org-server
      - mongodb-org-shell
      - mongodb-org-tools
    state: present
  ignore_errors: "{{ ansible_check_mode }}"

# the SHA sums of the mongodb-database-tools include files which are not actually present in the package
# debsums detects these as missing files and sends a warning to the user. Add these files to debsums ignore list
- name: prevent incorrect debsums reports about missing files in mongodb-database-tools
  lineinfile:
    path: /etc/debsums-ignore
    line: "{{ item }}"
    state: present
    owner: root
    group: root
    mode: "0600"
    create: yes
  with_items:
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/bsondump
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongodump
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongoexport
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongofiles
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongoimport
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongorestore
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongostat
    - /mongodb-database-tools-debian..-x86_64-100..../usr/bin/mongotop
    - /mongodb-database-tools-debian..-x86_64-100..../usr/share/doc/mongodb-database-tools/LICENSE.md
    - /mongodb-database-tools-debian..-x86_64-100..../usr/share/doc/mongodb-database-tools/README.md
    - /mongodb-database-tools-debian..-x86_64-100..../usr/share/doc/mongodb-database-tools/THIRD-PARTY-NOTICES

### SERVICE ###

- name: enable/disable start/stop mongodb service
  systemd:
    name: mongod
    enabled: "{{ graylog_enable_service }}"
    state: "{{ 'started' if graylog_enable_service else 'stopped' }}"
    daemon_reload: yes
  ignore_errors: "{{ ansible_check_mode }}"
