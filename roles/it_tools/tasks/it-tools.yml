##### USER #####

- name: create it-tools user
  become: yes
  user:
    name: it-tools
    state: present
    home: /var/lib/it-tools
    create_home: yes

- name: check if systemd/logind session lingering is enabled
  stat:
    path: "/var/lib/systemd/linger/it-tools"
  register: linger_file

- name: enable systemd/logind session lingering
  become: yes
  command:
    cmd: loginctl enable-linger it-tools
  changed_when: yes
  when: not linger_file.stat.exists

##### PODMAN ####

- name: pull it-tools image
  become: yes
  become_user: it-tools
  containers.podman.podman_image:
    name: "{{ it_tools_image }}"
    force: yes
  ignore_errors: "{{ ansible_check_mode }}"
  notify: restart it-tools service

# to access the instance from another host, the firewall must allow incoming connections on port 8000/tcp (sudo firewall-cmd --add-port=8000/tcp --zone=internal)
- name: run it-tools container
  become: yes
  become_user: it-tools
  containers.podman.podman_container:
    name: it-tools
    image: "{{ it_tools_image }}"
    publish:
      - "8090:80"
  ignore_errors: "{{ ansible_check_mode }}"
  when: it_tools_enable_service | bool

- name: configure nightly cleanup of unused podman data
  become: yes
  cron:
    user: it-tools
    cron_file: it-tools-podman-system-prune
    name: "cleanup unused podman data"
    minute: "40"
    hour: "03"
    day: "*"
    job: podman system prune --all --force | logger -t it-tools-podman-system-prune


##### SERVICE #####

- name: generate systemd unit file for it-tools container
  become: yes
  become_user: it-tools
  containers.podman.podman_generate_systemd:
    name: it-tools
    use_names: yes
    dest: ~/.config/systemd/user
    no_header: yes
  notify:
    - reload systemd unit files (it-tools)
    - restart it-tools service
  ignore_errors: "{{ ansible_check_mode }}"
  when: it_tools_enable_service | bool

- name: apply configuration (flush handlers)
  meta: flush_handlers

# use sudo systemctl --user --machine it-tools@ list-units to list another user's services
- name: enable it-tools service
  become: yes
  become_user: it-tools
  systemd:
    name: container-it-tools.service
    scope: user
    state: "{{ 'started' if it_tools_enable_service else 'stopped' }}"
    enabled: "{{ 'yes' if it_tools_enable_service else 'no' }}"
  ignore_errors: "{{ ansible_check_mode }}"
