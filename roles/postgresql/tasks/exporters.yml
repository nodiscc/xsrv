- name: install prometheus-postgres-exporter
  apt:
    package: prometheus-postgres-exporter
    state: present

- name: create prometheus postgresql user
  become_user: postgres
  become: true
  community.postgresql.postgresql_user:
    name: prometheus
    quote_configuration_values: false
    configuration:
      search_path: prometheus,pg_catalog

- name: grant pg_monitor,pg_read_all_stats privileges to prometheus postgresql user
  become_user: postgres
  become: true
  community.postgresql.postgresql_privs:
    roles: prometheus
    login_db: postgres
    type: group
    objs: pg_monitor,pg_read_all_stats
    admin_option: false

- name: copy prometheus schema creation script
  copy:
    src: var_lib_prometheus_create-postgresql-exporter-schema.sql
    dest: /var/lib/prometheus/create-postgresql-exporter-schema.sql
    owner: root
    group: root
    mode: "0644"

- name: run prometheus schema creation script
  become_user: postgres
  become: true
  community.postgresql.postgresql_script:
    path: /var/lib/prometheus/create-postgresql-exporter-schema.sql
  when: ansible_local.prometheus_postgresql_exporter.prometheus_schema_created is not defined

- name: copy prometheus postgresql exporter configuration
  template:
    src: etc_default_prometheus-postgres-exporter.j2
    dest: /etc/default/prometheus-postgres-exporter
    owner: prometheus
    group: prometheus
    mode: "0640"
  notify: restart prometheus postgresql exporter

- name: add postgres exporter to exporter-exporter configuration
  template:
    src: etc_prometheus_exporter-exporter_postgres.yaml.j2
    dest: /etc/prometheus/exporter-exporter/postgres.yaml
    owner: root
    group: prometheus
    mode: "0640"
  notify: restart prometheus-exporter-exporter

- name: start and enable prometheus-postgres-exporter
  systemd:
    name: prometheus-postgres-exporter.service
    state: started
    enabled: true

### FACT

- name: create ansible facts.d directory
  file:
    path: /etc/ansible/facts.d
    state: directory
    mode: "0755"

- name: create postgresql fact file
  template:
    src: etc_ansible_facts.d_prometheus_postgresql_exporter.fact.j2
    dest: /etc/ansible/facts.d/prometheus_postgresql_exporter.fact
    mode: "0644"
  notify: update ansible facts
  ignore_errors: "{{ ansible_check_mode }}"
