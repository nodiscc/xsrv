##### JELLYFIN INSTALLATION #####

- name: install jellyfin requirements
  apt:
    state: present
    package:
      - apt-transport-https

- name: import jellyfin gpg signing key
  apt_key:
    state: present
    url: https://repo.jellyfin.org/debian/jellyfin_team.gpg.key
  ignore_errors: "{{ ansible_check_mode }}"

- name: add jellyfin APT repository
  apt_repository:
    state: present
    repo: deb [arch=amd64] https://repo.jellyfin.org/debian {{ ansible_facts.distribution_release | lower }} main
    filename: jellyfin

- name: install jellyfin
  apt:
    state: present
    package: jellyfin
  notify: display jellyfin first run message
  ignore_errors: "{{ ansible_check_mode }}"

##### MEDIA DIRECTORIES #####

- name: create default media directories
  file:
    path: "/var/lib/jellyfin/{{ item }}"
    state: directory
    owner: jellyfin
    group: jellyfin
    mode: 02770
  with_items:
    - media
    - media/movies
    - media/music
    - media/shows
    - media/books
    - media/photos
    - media/musicvideos
    - media/mixedcontent

- name: create symlink from home directory to jellyfin media directory
  file:
    state: link
    dest: "{{ ansible_env.HOME }}/MEDIA"
    src: "/var/lib/jellyfin/media/"
  ignore_errors: "{{ ansible_check_mode }}"

# required to allow jellyfin group to write in subdirectories
- name: set permissions on jellyfin data directory
  file:
    path: /var/lib/jellyfin
    owner: jellyfin
    group: jellyfin
    mode: 0770
  ignore_errors: "{{ ansible_check_mode }}"

- name: allow ansible user to read/write jellyfin data files
  user:
    name: "{{ ansible_user }}"
    groups: jellyfin
    append: yes
  ignore_errors: "{{ ansible_check_mode }}"

- name: allow jellyfin to read/write transmission downloads directory
  user:
    name: jellyfin
    groups: debian-transmission
    append: yes
  when:
    - ansible_local.transmission.ansible_managed is defined
    - ansible_local.transmission.ansible_managed | bool
  ignore_errors: "{{ ansible_check_mode }}"

##### SERVICE #####

- name: start/stop/enable/disable jellyfin service
  service:
    name: jellyfin
    state: "{{ 'started' if jellyfin_enable_service else 'stopped' }}"
    enabled: "{{ 'yes' if jellyfin_enable_service else 'no' }}"
  tags: services
  ignore_errors: "{{ ansible_check_mode }}"
